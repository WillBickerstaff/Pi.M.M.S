#!/opt/pimms/bin/python

import os, sys, subprocess, signal
from optparse import OptionParser
import monitor
from util import check_file


parser = OptionParser()
parser.add_option('-d', '--db', default='templog.db', dest='db',
			help='Database location')
parser.add_option('-i', '--int', default='60', dest='logint',
			help='Log interval in seconds')
parser.add_option('-j', '--json', default='www/static/json/', dest='jsonf',
			help='Location for created JSON files')

def db_error(db):
    print "ERROR: Can not open or create database %s"%db
    sys.exit(1)

def int_handler(signal, frame):
    print 'Exiting'
    sys.exit(0)


signal.signal(signal.SIGINT, int_handler)


if __name__=='__main__':
    try:
        (options, args) = parser.parse_args()
        check_file(options.db)
        # Must set this so as gunicorn dynamic pages no where the db is
        os.environ['PIMMS_DB'] = os.path.abspath(options.db)
        print 'Starting Monitor...'
        subprocess.Popen(['python', 'monitor.py',
                          '-i', options.logint,
                          '-d', options.db,
                          '-j', options.jsonf])
        print 'Starting Gunicorn'
        subprocess.Popen(['gunicorn', 'www.web:app', '--debug', '-b',
                          'localhost:9001'])
        signal.pause()
    except KeyboardInterrupt:
        raise
